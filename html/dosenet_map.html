<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="pragma" content="no-cache" />
	<title>DoseNet @ UC Berkeley</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="googlebot" content="snippet,follow" />
	<meta name="robots" content="index,follow" />
	<meta http-equiv="last-modified" content="2015-11-06 14:30 GMT" />
	<meta name="copyright" content="© 2015 Navrit Bal, Tigran Ter-Stepanyan and Luke Sheard" />
	<meta name="author" content="Navrit Bal, Tigran Ter-Stepanyan, Luke Sheard" />
	<meta http-equiv="refresh" content="300;url=https://radwatch.berkeley.edu/dosenet/map">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSaBOz47zWi5eWz12SYzSl6GMSpl8l1c8&callback=initMap"></script>
	<script type="text/javascript" 
		src="https://google-maps-utility-library-v3.googlecode.com/svn/tags/markerwithlabel/1.1.9/src/markerwithlabel_packed.js">
		</script>
	<script type="text/javascript"
		src="https://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer.js">
		</script>
	<script src="https://radwatch.berkeley.edu/sites/default/files/dosenet/data_processing.js"></script>
	<script type="text/javascript"
		src="//cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js">
		</script>

	<style type="text/css">
		@font-face {
			font-family: 'Garamond';
			src: local('Garamond'), url('Garamond.ttf') format('truetype');
		}
		#main-area {
		    background-image: none;
		    background: gray;
		}
		#map-canvas {
			width: 100%;
			min-height: 65vh;
			margin-bottom:1em !important;
			margin-top: 0.0em !important;
		}
		#dosimeter_list {
			padding: 0.5em;
			margin-left: 1em;
			width: 100%;
		}
		.div {
			vertical-align: middle;
		}
		#my_banner {
	  		padding-top:15px;
	  		padding-bottom:15px;
	  		padding-right:20px;
	  		padding-left:20px;
	  		background:#5b6770;
	  		font-size:16px;
	  		line-height:150% !important;
	  		color: white;
	  		border-radius: 15px;
	  		border-color: #d19000;
	  		border-width: 3px;
	  		border-style: solid;
			margin-bottom: 1em;
  		}
		.jh5 {
			padding: 0.5em 0 0 0;
			font-size: 2em;
			text-align: center;
		}
		.jh2 {
			font-size: 3em;
		}
		.jp {
			padding: 1vw;
			font-size: 1.2em;
			text-align: center;
		}
		.header-text {
			font-size: 2vw;
			font-family: 'Garamond', Arial, sans-serif;
		}
		.names {
			font-family: 'Garamond', Arial, sans-serif;
			color: #D19000 !important;
		}
		.reddot {
			height:1.5em !important;
			margin-top: 0.5em !important;
			margin-left: auto;
	    margin-right: auto;
		}
		.plot {
			width:100%;
			min-height: 35em;
		}
		.center {
			text-align: center;
		}
		.vcenteralign {
			vertical-align: center;
		}
		.transbg {
			background-color:transparent !important;
		}
		.dropdown {
			margin: auto;
			margin-top: 0.5em;
			margin-bottom: 0.5em;
		}
		.roundedwrapper {
			background-color: rgba(255,255,255,0.8);
			border-radius: 10px;
			padding: 0.5em;
			border: 2px solid;
			border-color: #CED1D4;
		}
		.paddingtop {
			padding-top: 1em;
		}
		.paddingright {
			padding-right: 1em;
		}
		.labels {
			background-color: #ffffff;
			-moz-border-radius: 5px;
			border-radius: 5px;
			font-size:110%;
		}
		.label-info {
			background-color: #5bc0de;
		}
		.label {
			display: inline;
			padding: .2em .6em .3em;
			font-size: 75%;
			font-weight: bold;
			line-height: 1;
			color: #fff;
			text-align: center;
			white-space: nowrap;
			vertical-align: baseline;
			border-radius: .25em;
		}
		.label-info[href]:hover,
		.label-info[href]:focus {
			background-color: #31b0d5;
		}
		button,
		input,
		optgroup,
		select,
		textarea {
			margin: 0;
			font: inherit;
			color: inherit;
		}
		button {
			overflow: visible;
		}
		button,
		select {
			text-transform: none;
		}
		button,
		html input[type="button"],
		input[type="reset"],
		input[type="submit"] {
			-webkit-appearance: button;
			cursor: pointer;
		}
		button[disabled],
		html input[disabled] {
			cursor: default;
		}
		button::-moz-focus-inner,
		input::-moz-focus-inner {
			padding: 0;
			border: 0;
		}
		.btn {
			display: inline-block;
			padding: 6px 12px;
			margin-bottom: 0;
			font-size: 14px;
			font-weight: normal;
			line-height: 1.42857143;
			text-align: center;
			white-space: nowrap;
			vertical-align: middle;
			-ms-touch-action: manipulation;
			touch-action: manipulation;
			cursor: pointer;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			background-image: none;
			border: 1px solid transparent;
			border-radius: 4px;
		}
		.btn:focus,
		.btn:active:focus,
		.btn.active:focus,
		.btn.focus,
		.btn:active.focus,
		.btn.active.focus {
			outline: thin dotted;
			outline: 5px auto -webkit-focus-ring-color;
			outline-offset: -2px;
		}
		.btn:hover,
		.btn:focus,
		.btn.focus {
			color: #333;
			text-decoration: none;
		}
		.btn:active,
		.btn.active {
			background-image: none;
			outline: 0;
			-webkit-box-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);
			      box-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);
		}
		.btn.disabled,
		.btn[disabled],
		fieldset[disabled] .btn {
			pointer-events: none;
			cursor: not-allowed;
			filter: alpha(opacity=65);
			-webkit-box-shadow: none;
			      box-shadow: none;
		  opacity: .65;
		}
		.btn-info {
		  color: #fff;
		  /*background-color: #5bc0de;*/
		  background-color: #00B5E2;
		  border-color: #46b8da;
		}
		.btn-info:hover,
			.btn-info:focus,
			.btn-info.focus,
			.btn-info:active,
			.btn-info.active,
			.open > .dropdown-toggle.btn-info {
		  color: #fff;
		  background-color: #00A5F2;
		  /*background-color: #31b0d5;*/
		  border-color: #269abc;
		}
		.btn-info:active,
			.btn-info.active,
			.open > .dropdown-toggle.btn-info {
		  background-image: none;
		}
		.btn-info.disabled,
			.btn-info[disabled],
			fieldset[disabled] .btn-info,
			.btn-info.disabled:hover,
			.btn-info[disabled]:hover,
			fieldset[disabled] .btn-info:hover,
			.btn-info.disabled:focus,
			.btn-info[disabled]:focus,
			fieldset[disabled] .btn-info:focus,
			.btn-info.disabled.focus,
			.btn-info[disabled].focus,
			fieldset[disabled] .btn-info.focus,
			.btn-info.disabled:active,
			.btn-info[disabled]:active,
			fieldset[disabled] .btn-info:active,
			.btn-info.disabled.active,
			.btn-info[disabled].active,
			fieldset[disabled] .btn-info.active {
		  background-color: #5bc0de;
		  border-color: #46b8da;
		}
		.btn-info .badge {
		  color: #5bc0de;
		  background-color: #fff;

		}
		.btn-sm,
		.btn-group-sm > .btn {
			padding: 5px 10px;
			font-size: 1em;
			line-height: 1.5;
			border-radius: 3px;
		}
		.jumbotron {
		  padding: 30px 15px;
		  margin-bottom: 2em;
		  color: white;
		  background-color: #5B6770;
		  margin-top:0em;
		}
		.jumbotron h1,
		.jumbotron .h1 {
		  color: inherit;
		}
		.jumbotron p {
		  margin-bottom: 0.5em;
		  font-size: 1.5em;
		  font-weight: 100;
		}
		.jumbotron > hr {
		  border-top-color: #d5d5d5;
		}
		.container .jumbotron,
		.container-fluid .jumbotron {
		  border-radius: 6px;
		}
		.jumbotron .container {
		  max-width: 100%;
		}
		#logo-canvas {
			width: 25%;
			margin-bottom:1em !important;
			margin-top: 1em !important;
	  	}
		@media screen and (min-width: 768px) {
		  .jumbotron {
		    padding: 1em 0;
		  }
		  .container .jumbotron,
		  .container-fluid .jumbotron {
		    padding-right: 2em;
		    padding-left: 2em;
		  }
		  .jumbotron h1,
		  .jumbotron .h1 {
		    font-size: 2em;
		  }
		}
	</style>

<script type="text/javascript">
	function https(){
		var URL = document.URL;
		var secureURL = URL.replace("http:","https:");
	} 
	function calibration() {
		document.getElementById("text_field").innerHTML = 
			"<div class = \"jumbotron\" >" +
			"<div class = \"jh5\">" +
			"</div>" + 
			"<div class = \"jp\">" +
			"The DoseNet devices measure radiation counts to get counts per minute (CPM). However, CPM is not a useful measurement of radiation in our environment, because one count in a DoseNet device is different from one count in a Geiger counter, which is different from one count in a germanium detector, and so on. The counts in any detector have to be *calibrated* to represent a physical unit of dose rate, such as µSv/hr. The procedure used to calibrate our devices is described on the " +
			"<a href=\"https://radwatch.berkeley.edu/dosenet/calibrations\">" + "Calibration Page" + "</a>";
	}
    function units_used() {
        document.getElementById("text_field").innerHTML =
			"<div class =\"jumbotron\" >" +
			"<div class =\"jh5\">" +
				"Units Used" +
			"</div>" +
			"<div class =\"jp\">" +
			"Background radiation is present everywhere. However, there are also many common, everyday human activities that expose you to radiation. The units used here are a sample of different sources of radiation in everyday activity and allow you to compare the background dose to these different activities. To see a description of how the unit conversion was determined, select that unit type form the drop down menu. In these cases the dose stated corresponds to the effective dose equivalent for that exposure." +
			"</div>" +
			"</div>";
        }
	function map_explained() {
		document.getElementById("text_field").innerHTML =
			"<div class =\"jumbotron\" >" +
			"<div class =\"jh5\">" +
				"How the map works" +
			"</div>" +
			"<div class =\"jp\">" +
			"The map uses Google Maps with pinpoints at each dosimeter location. These dosimeters then update to show the current radiation level. Clicking on any of the points will bring up a new window, displaying more information about the individual detector and allow you to view the radiation level as a function of time. The units can be changed using the dropdown just above the map. These units show the background radiation level in more familiar terms." +
			"</div>" +
			"</div>";
	}

	function about_radiation(){
		document.getElementById("text_field").innerHTML =
			"<div class =\"jumbotron\" >" +
			"<div class =\"jh5\">" +
				"The radiation level is higher today than it was yesterday. Should I be concerned?" +
			"</div>" +
			"<div class =\"jp\">" +
			"Probably not. In the same way that some days are windy and other days are calm, the background radiation level can change from day to day.  The natural background in an area can easily change by a factor of 10 through the effects of weather." +
			"</div>" +

			"<div class =\"jh5\">" +
				"The area where I live seems higher than other areas, should I be concerned?" +
			"</div>" +
			"<div class =\"jp\">" +
			"Different locations have different amounts of natural radiation background, due to differences in the rocks and soil as well as elevation. For example, the sand of certain beaches in Brazil are naturally hundreds of times more radioactive than sand in California. And the background in Denver is considerably higher than that at sea level. Variations in background level are to be expected." +
			"</div>" +
			"<div class=\"jp\">" +
			"<a href=\"http://www2.epa.gov/radiation/radiation-sources-and-doses\">EPA - radiation sources and doses</a>" +
			"</div>" +
			"</div>";
	}

	function about_dosenet(){
		document.getElementById("text_field").innerHTML =
			"<div class =\"jumbotron\" >" +
			"<div class =\"jh5\">" +
				"About the Devices" +
			"</div>" +
			"<div class =\"jp\">" +
			"The DoseNet devices are radiation detectors being placed at schools throughout the Bay Area, as well as at multiple locations at UC Berkeley and Lawrence Berkeley National Lab (LBNL). These dosimeters count radiation interactions that deposit energy in the device, giving the counts per minute (CPM) averaged over a 5-minute interval. The CPM is converted to a rate of radiation dose that people are being exposed to.  Each dosimeter then takes this measurement and sends it to a central server, where it is displayed on RadWatch.  This system allows for real-time monitoring of radiation levels." +
			"</div>" +
			"</div>";
	}

	timeframe = "hour";
	function get_timeframe(){
		var sel_time = document.getElementById('time_dropdown');
		timeframe = sel_time.options[sel_time.selectedIndex].value;
	}

	unit = "CPM";
	function setHTML_units(){
		var sel = document.getElementById('dose_dropdown');
		unit = sel.options[sel.selectedIndex].value;
		switch(unit) {
			case 'cigarette':
		        document.getElementById("text_field").innerHTML =
				"<div class =\"jumbotron\" >" +
				"<div class =\"jh5\">" +
				"Cigarettes" + "<br>(1 pack (20 cigarettes) = 6 µSv)</a>" +
				"</div>" +
				"<div class =\"jp\">" +
				"'While cigarette smoke is not an obvious source of radiation exposure, it contains small amounts of radioactive materials [polonium-210 and lead-210] which smokers bring into their lungs as they inhale. The radioactive particles lodge in lung tissue and over time contribute a huge radiation dose. Radioactivity may be one of the key factors in lung cancer among smokers.' <br><a href=\"http://www.epa.gov/radiation/sources/tobacco.html\">U.S. Environmental Protection Agency</a>" +
				"<br><br>" +
				"The National Council on Radiation Protection and Measurements suggests that tobacco products are probably the greatest single contributor to effective dose equivalent in the population at large, even greater than medical procedures and natural background. [NCRP Report No. 93 summarizing exposures from all sources (NCRP, 1987a)]. <br><a href=\"http://www.ncrponline.org/Learn_More/Did_You_Know_95.html\">Equivalent dose estimation</a>" +
				"<br><br>The values shown compare the effective dose equivalent for how many cigarettes would give you the same dose per hour." +
				"<br><a href=\"http://www.rmeswi.com/36.html\">Radiation Measurement and Elimination Services</a>" +
				"</div>" +
				"</div>";
			break;
			case 'plane':
		        document.getElementById("text_field").innerHTML =
				"<div class =\"jumbotron\" >" +
				"<div class =\"jh5\">" +
				"Time on Airplane" + "<br>(2.38 µSv per hour)" +
				"</div>" +
				"<div class =\"jp\">" +
				"Radiation also comes from the sun, solar wind, and other cosmic radiation. The bulk of this radiation is blocked by the Earth’s atmosphere. However, when flying across the country, the increased altitude there is less atmosphere above you to protect you from this cosmic radiation. This means that while flying in an airplane, you receive a higher dose of radiation than you would on the ground." +
				"<br><br>The values shown indicate the amount of time on an airplane would correspond to the same effective dose." +
				"<br><a href=\"http://www.hps.org/publicinformation/ate/faqs/commercialflights.html\">HPS Public Information on commerical airplane flights</a>" +
				"</div>" +
				"</div>";
			break;
			case 'medical':
		        document.getElementById("text_field").innerHTML =
				"<div class =\"jumbotron\">" +
				"<div class =\"jh5\">" +
				"Medical Procedures" + "<br>(X-ray = 5 - 15 µSv, Chest CT = 7000 µSv)" +
				"</div>" +
				"<div class =\"jp\">" +
				"Getting x-rayed at the dentist’s office or getting CT scans at a hospital are common occurrences. These forms of imaging help doctors see inside the body and allow them to more easily do their jobs. However, such procedures do expose one’s body to some dose of radiation. This amount varies from procedure to procedure." +
				"<br><br>The values shown compare how many 5 µSv X-rays would need to be taken to give you the same effective dose as standing at this location for one hour." +
				"<br><a href=\"http://www.radiologyinfo.org/en/pdf/sfty_xray.pdf\">Radiology information</a>" +
				"<br><a href=\"http://www.nrc.gov/about-nrc/radiation/around-us/doses-daily-lives.html\">NRC - Daily lives</a>" +
				"</div>" +
				"</div>";
			break;
			case 'CPM':
				document.getElementById("text_field").innerHTML =
				"<div class =\"jumbotron\">" +
				"<div class =\"jh5\">" +
				"CPM" +
				"</div>" +
				"<div class =\"jp\">" +
				"Counts per minute on the detector averaged over a 5-minute measurement" +
				"</div>" +
				"</div>";
			break;
			case 'REM':
			    document.getElementById("text_field").innerHTML =
				"<div class =\"jumbotron\">" +
				"<div class =\"jh5\">" +
				"Millirem per hour (mrem/hr)"+ "<br>1 mrem/hr = 10 µSv/hr" +
				"</div>" +
				"<div class =\"jp\">" +
				"The millirem (equal to 1/1000th of a rem) is an older measurement of radiation dose that the Sievert replaced. It is still common  however, in the literature on radiation dose. Because of this, it is included in here as well. The mREM/hr unit is the dose rate - the dose absorbed per hour of exposure." +
				"</div>" +
				"</div>";
			break;
			case 'USV':
			document.getElementById("text_field").innerHTML =
				"<div class =\"jumbotron\">" +
				"<div class =\"jh5\">" +
				"Micro-Sievert per hour (µSv/hr)" +
				"</div>" +
				"<div class =\"jp\">" +
				"The Sievert is the standard (SI) unit of absorbed dose. It is related to the amount of energy that radiation deposits in the body. 1 Sv is defined as being 1 joule of energy that is absorbed in 1 kg of tissue, multiplied by a quality factor depending on the type of radiation. 1 µSv is equal to 10^-6 (0.000001) Sv. Sv/hr is the dose rate - the dose absorbed per hour of exposure." +
				"</div>" +
				"</div>";
			break;
			default:
			document.getElementById("text_field").innerHTML = "...";
		}
	}
</script>
<script>
	var map; // Google Map Object
	var berkeley = [37.872269, -122.258901];
	var markers = [];
	var json_vals = [];
	var markerCluster;
	var marks = [];
	var infowindow = new google.maps.InfoWindow();
	// url for geoJSON file
	var url = 'https://radwatch.berkeley.edu/sites/default/files/output.geojson?'
		+ Math.random().toString(36).replace(/[^a-z]+/g, ''); // To solve browser caching issue
	var json = $($.parseJSON(JSON.stringify($.getJSON(url))));
	var parsed_json = '';
	var time = '';
	var dose = '';
	var dosimeter_name = '';
	var graph_url = '';
	var selected_marker = '';
	var selected_val = '';

	function centerMap(center){
		var mapCenter = new google.maps.LatLng(center[0], center[1]);
		map.setCenter(mapCenter);
	}

	// These two functions should be temporary until this can be done in makeGeoJSON as we phase out plot.ly
	function getURL(val){
		var name = val.properties["Name"];
		var url;
		switch(name) {
			case 'LBL':
				url = 'https://radwatch.berkeley.edu/sites/default/files/dosenet/lbl.csv?'
				  + Math.random().toString(36).replace(/[^a-z]+/g, ''); // To solve browser caching issue
			break;
			case 'Campolindo High School':
				url = 'https://radwatch.berkeley.edu/sites/default/files/dosenet/campolindo.csv?'
				  + Math.random().toString(36).replace(/[^a-z]+/g, ''); // To solve browser caching issue
			break;
			case 'Pinewood High School':
				url = 'https://radwatch.berkeley.edu/sites/default/files/dosenet/pinewood.csv?'
				  + Math.random().toString(36).replace(/[^a-z]+/g, ''); // To solve browser caching issue
			break;
			case 'Etcheverry Hall':
				url = 'https://radwatch.berkeley.edu/sites/default/files/dosenet/etch.csv?'
				  + Math.random().toString(36).replace(/[^a-z]+/g, ''); // To solve browser caching issue
			break;
			case 'Etcheverry Hall Roof':
				url = 'https://radwatch.berkeley.edu/sites/default/files/dosenet/etch_roof.csv?'
				  + Math.random().toString(36).replace(/[^a-z]+/g, ''); // To solve browser caching issue
			break;
		}
		return url;
	}
	function getName(val){
		var name = val.properties["Name"];
		var short_name = 'NONAME';
		switch(name) {
			case 'LBL':
				short_name = 'LBL';
			break;
			case 'Campolindo High School':
				short_name = 'Campolindo';
			break;
			case 'Pinewood High School':
				short_name = 'Pinewood';
			break;
			case 'Etcheverry Hall':
				short_name = 'Etcheverry Hall';
			break;
			case 'Etcheverry Hall Roof':
				short_name = 'Etcheverry Roof';
			break;			
		}
		return short_name;
	}

	function updateInfowindowContent(val){
		time = getTimeframe();
		dose = getDoseUnit();
		url = getURL(val);
		name = getName(val);

		var plotly_url = "URL_" + dose + "_" + time;
		var iframeIntro = "<iframe width=\"500\" height=\"400\" frameborder=\"0\" \
			seamless=\"seamless\" scrolling=\"no\" src=\"";
		var iframeEnding = ".embed?width=500&height=400\"></iframe>";
		graph_url = val.properties[plotly_url.toString()];

		//return iframeIntro + graph_url + iframeEnding;
		var node_name = dose + '_' + time + '_' + name;
		var content_string = '<div id="' + node_name + '"" style="width:500px; height=400px"></div>';
		get_data(url.toString(),name.toString(),dose,time,node_name);
		return content_string;
	}

	// Time units for a plot, called in updateInfowindowContent
	function getTimeframe(){
		infowindow.close();
		var sel_time = document.getElementById('time_dropdown');
		return sel_time.options[sel_time.selectedIndex].value;
	}

	// Dose units for a plot, called in updateInfowindowContent
	function getDoseUnit(){
		var sel = document.getElementById('dose_dropdown');
		return sel.options[sel.selectedIndex].value;
	}

	function clearMarkers() {
	  markerCluster.clearMarkers();
	  for (var i = 0; i < markers.length; i++) {
	    markers[i].setMap(null);
	  }
	  markers = [];
	}

	function setMarkerIcon(marker){
        // Sets Marker Icon to [red, green, yellow, purple, green] marker
        marker.setIcon('https://maps.google.com/mapfiles/ms/icons/red-dot.png');
	}

	function repopulateMarkers(){
		$.getJSON(url, function(data){
			$.each(data.features, function(key, val){
				var lon = getCoords(val).lon;
				var lat = getCoords(val).lat;
		        var marker = new MarkerWithLabel({
		            map: map,
		            title: name,
		            position: new google.maps.LatLng(lat, lon),
		            labelContent: getLabelContent(val),
		            labelAnchor: new google.maps.Point(20, 0),
		            labelClass: "labels",
		        });
		        markers.push(marker);
		        setMarkerIcon(marker);
				addMarkerEventListeners(val, marker);
	      	});
			markerCluster.addMarkers(markers);
		});
	}

	function changeDoseUnits(){
		setHTML_units();
		for (var i = 0; i < markers.length; i++) {
			var label_text = getLabelContent(json_vals[i]);
			markers[i].labelVisible = false;
			markers[i].setOptions({ labelContent: label_text });
			//markers[i].labelContent = label_text;
			markers[i].labelVisible = true;
		}
	}

	function getDosimeterCoords(index){
		var lat = parsed_json.features[index].geometry.coordinates[1];
		var lon = parsed_json.features[index].geometry.coordinates[0];
		var location = new google.maps.LatLng(lat, lon);
		return location
	}

	function getSelectedDosimeterIndex(){
		var sel = document.getElementById('dosimeter_list');
		var index = sel.selectedIndex;
		dosimeter_name = sel.options[sel.selectedIndex].value;
		return index;
	}

	function goToDosimeter(){
		infowindow.close();
		var index = getSelectedDosimeterIndex();
		var center = getDosimeterCoords(index);
		map.setCenter(center);
	}

	function initMap(){
		map = new google.maps.Map(document.getElementById('map-canvas'), {
			zoom: 9,
			disableDefaultUI: true
		});
		google.maps.event.addListener(map, 'click', function() {
			infowindow.close();
		});
	}

	function getCoords(val){
		return {
			lon : val.geometry.coordinates[0],
			lat : val.geometry.coordinates[1]
		}
	}

	function getLabelContent(val){
		selected_unit = getDoseUnit();
		switch(selected_unit) {
			case 'CPM':
				latest_val = (val.properties["Latest dose (CPM)"]).toFixed(1);
				break;
			case 'REM':
				selected_unit = 'mrem/hr'
				latest_val = (val.properties["Latest dose (mREM/hr)"]).toFixed(4);
				break;
			case 'USV':
				selected_unit = '&microSv/hr'
				latest_val = (val.properties["Latest dose (&microSv/hr)"]).toFixed(3);
				break;
			case 'plane':
				selected_unit = 'plane travel/hr'
				latest_val = (val.properties["Latest dose (&microSv/hr)"]*0.420168067).toFixed(4);
				break;
			case 'cigarette':
				selected_unit = 'cigarettes/hr'
				latest_val = (val.properties["Latest dose (&microSv/hr)"]*0.00833333335).toFixed(4);
				break;
			case 'medical':
				selected_unit = 'X-Rays/hr'
				latest_val = (val.properties["Latest dose (&microSv/hr)"]*0.2).toFixed(4);
				break;
			default:
				latest_val = (val.properties["Latest dose (&microSv/hr)"]).toFixed(3);
				break;
		}
		return ("&nbsp" + latest_val + "&nbsp" + selected_unit + "&nbsp");
	}

	function addMarkerEventListeners(val, marker){
		// Adds listener to open infowindow with content from updateInfowindowContent()
		// updateInfowindowContent() will allow you to enter the graphs from the geoJSON file
		google.maps.event.addListener(marker, 'click', (function(marker) {
			return function() {
				infowindow.setContent(updateInfowindowContent(val));
				infowindow.open(map, marker);
				selected_val = val;
				selected_marker = marker;
			};
		})(marker));
	}

	function addTimeDropdownListener(){
		$("#time_dropdown").change(function(){
			//infowindow.close();
			goToDosimeter();
			infowindow.setContent(updateInfowindowContent(selected_val));
			infowindow.open(map, selected_marker);
		});
	}

	function addUnitDropdownListener(){
		$("#dose_dropdown").change(function(){
			//infowindow.close();
			goToDosimeter();
			infowindow.setContent(updateInfowindowContent(selected_val));
			infowindow.open(map, selected_marker);
		});
	}

	$(document).ready(function(){
		var marker;
		initMap();
		centerMap(berkeley); //Because we're self-centered.

		// Fetch geoJSON file - runs function on complete, 'data' is extracted from JSON
		$.getJSON(url, function(data){
			parsed_json = data;
			// For each item in "features" array inside data runs function
			// key: position of item in the array Features
			// val: value of item
			$.each(data.features, function(key, val){
				$("#dosimeter_list").append($("<option />").text(val.properties["Name"]));
				var lon = getCoords(val).lon;
				var lat = getCoords(val).lat;
		        var marker = new MarkerWithLabel({
		            map: map,
		            title: name,
		            position: new google.maps.LatLng(lat, lon),
		            labelContent: getLabelContent(val),
		            labelAnchor: new google.maps.Point(20, 0),
		            labelClass: "labels",
								animation: google.maps.Animation.DROP
		        });
				markers.push(marker);
		        json_vals.push(val);
			    setMarkerIcon(marker);
				addMarkerEventListeners(val, marker);
		    });
			addTimeDropdownListener();
			addUnitDropdownListener();
			var mcOptions = {gridSize: 40, maxZoom: 15};
			markerCluster = new MarkerClusterer(map, markers, mcOptions);
		});
	});
	</script>
</head>
<body>
	<div id=my_banner>
	    This map shows background radiation measured throughout our network of small sensors maintained and operated by students around the Bay Area and the UC Berkeley team.
	</div>

	<div>
		<a href="https://radwatch.berkeley.edu/dosenet/levels">
			<img id="dosenet_rad_banner" alt="Relative Radiation Levels"  src="/sites/default/files/pictures/RadiationRatesGraphic.jpg"/>
		</a>
	</div>

	<div class="roundedwrapper">
		<table class="center "style="float: left;">
			<tr>
    			<td class="paddingright">
					<div class="label label-info">
						Units to Display on Plots
					</div>
					<select id="dose_dropdown" class="dropdown" onChange='changeDoseUnits()'>
						<option value="USV"> µSv/hr </option>
						<option value="REM"> mrem/hr </option>
						<option value="CPM"> CPM </option>
						<option value="plane"> air travel/hr </option>
						<option value="medical"> X-rays/hr </option>
						<option value="cigarette"> cigarettes/hr </option>
					</select>
				</td>
				<td>
					<span class="glyphicon glyphicon-time"></span>
					<div class="label label-info">
						Timeframe
					</div>
					<select id="time_dropdown" class="dropdown" onChange='getTimeframe()'>
						<option value="Hour"> Last Hour </option>
						<option value="Day"> Last Day </option>
						<option value="Week"> Last Week </option>
						<option value="Month"> Last Month </option>
						<option value="Year"> Last Year </option>
					</select>
				</td>
				<td>
					<div class="label label-info">
						Dosimeter list
					</div>
					<select id="dosimeter_list" class="dropdown" onClick='goToDosimeter()'
						onChange='goToDosimeter()'>
					</select>
				</td>
			</tr>
		</table>
		<div id="map-canvas"></div>
	</div>
	<div class="center vcenteralign" style="padding:0.5em;">
		<a href="https://radwatch.berkeley.edu/dosenet/map"
			alt="Redirect to secure (HTTPS) version">
			Click here if you can't see any markers on the map</a>
	</div>
	<div class="center paddingtop">
		<button type="button" class="btn btn-info btn-sm"
			onclick="about_dosenet()">About the Devices</button>
		<button type="button" class="btn btn-info btn-sm"
			onclick="calibration()">Calibrating</button>
		<button type="button" class="btn btn-info btn-sm"
			onclick="about_radiation()">About Radiation</button>
		<button type="button" class="btn btn-info btn-sm"
			onclick="map_explained()">How the Map Works</button>
		<button type="button" class="btn btn-info btn-sm"
			onclick="units_used()">Units Used</button>
	</div>
	<div id="text_field">
		<script> about_dosenet(); </script>
	</div>
</body>
</html>
